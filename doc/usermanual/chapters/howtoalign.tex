\chapter{Alignment Procedure}
\label{ch:howtoalign}

This chapter provides a description of how to use the alignment features of \corry. 
It also includes step-by-step instructions on how to align a new set of testbeam data.

For the alignment of the \textbf{reference telescope} and \textbf{device-under-test (DUT)}, the following modules are available in \corry.
\begin{itemize}
\item \texttt{Prealignment} for both telescope and DUT prealignment (see Section~\ref{prealignment}).
\item \texttt{AlignmentTrackChi2} used for telescope alignment (see Section~\ref{alignmenttrackchi2}).
\item \texttt{AlignmentMillepede} for an improved telescope alignment (see Section~\ref{alignmentmillepede}).
\item \texttt{AlignmentDUTResidual} used for DUT alignment (see Section~\ref{alignmentdutresidual}).
\end{itemize}

The general procedure that needs to be followed for a successful alignment is outlined here and explained in detail below.
\begin{enumerate}
\item Prealignment of the telescope (ignore DUT)
\item Alignment of the telescope (ignore DUT)
\item Prealignment of the DUT (telescope geometry is frozen)
\item Alignment of the DUT (telescope alignment is frozen)
\end{enumerate}

\textbf{Note:} When using the alignment modules, the new geometry is written out to a new geometry file which needs to be specified using the parameter \texttt{detectors\_file\_updated}.
For details, see Section~\ref{sec:framework_parameters}.

\section{Aligning the Telescope}
\label{sec:align_tel}
Initially, the telescope needs to be aligned. 
For this, the DUT is ignored.

\subsection*{Prealignment of the Telescope}
The \texttt{AlignmentTrackChi2} module requires a careful prealignment. Otherwise it does not converge and the alignment will fail.
For the prealignment, two strategies can be applied.
\begin{itemize}
\item A rough manual prealignment can be performed by having a look at correlations plots between a defined reference plane and the others planes in both x and y.
These can be found in the module \texttt{TestAlgorithm} (see Section~\ref{sec:test_algorithm}).
\item The \texttt{Prealignment} module can be used (see Section~\ref{sec:prealignment}).
\end{itemize}

The z-position of all planes needs to be measured by hand \textbf{in the existing testbeam setup} and then adjusted in the detectors file. 
It will not be changed during the alignment process.
For x and y, the alignment file from the last testbeam is a solid basis to start from.
If no previous alignment is available, all values for x and y should be set to 0.

To have a first look at the initial alignment guess, one can run
\begin{verbatim}
    /path/to/corryvreckan/bin/corry 
        -c analyse_telescope.conf
    	[-o detectors_file=<detectorsFile> 
    	-o histogramFile=<histogramFile> 
    	-o EventLoaderTimepix3.inputDirectory=<inputDir>]
\end{verbatim}

The \texttt{spatialCut} in \texttt{[Tracking4D]} should be set to mulitple ($\sim4$) pixel size.

One can inspect the track $\chi^2$, the correlation in x and y and the residuals with the online monitoring or by opening the generated ROOT file after finishing the script (see \texttt{[Tracking4D]} and \texttt{[TestAlgorithm]}).

\textbf{Tip:} To save time, one can terminate \corry with \texttt{Ctrl+C} after a while (see also Section~\ref{sec:executable}).

If no peak at all is apparent in the correlations, the hitmaps can be checked to see if valid data is actually available for all planes.

For the residuals, the shift of the peak from 0 can be estimated with a precision of $\mathcal{O}(\SI{100}{\micro m})$ by zooming in using the \texttt{TBrowser}.
For instance, if the peak is shifted by +\SI{+300}{\micro m}, the detectors file needs to be edited and \SI{+300}{\micro m} should be added to the respective position, if \SI{-300}{\micro m}, subtracted.

After modifying the positions of individual planes in the configuration file, \corry can be re-run to check the correlation plots for the updated geometry.
These steps need to be iterated a few times until the peaks of the \textbf{residuals} are centered around 0.
 
It is important not to force the peak of the \textbf{correlations} to be at exactly 0 because the position of the peak in fact corresponds to the physical offset of a plane from its ideal position. 

Instead of a prealignment by hand, the \texttt{Prealignment} module can be used.
As explained in Section~\ref{sec:prealignment}, it is a \textit{DETECTOR} type module so it is instantiated once for each plane (including DUTs).
To prealign only the telescope, the DUT can be masked by setting \texttt{mask = <name\_of\_dut>}.
However, all planes can be prealigned at once.

Since the prealignment utilizes hit correlations rather than tracks, no cuts are needed here.

To use the module, \texttt{align\_tel.conf} needs to be edited such that \texttt{Prealignment} is enabled and \texttt{Alignment} is disabled:
\begin{minted}[frame=single,framesep=3pt,breaklines=true,tabsize=2,linenos]{ini}
...
[Prealignment]
mask = <name_of_dut> # <-- optional!
[Ignore]
#[AlignmentTrackChi2]
log_level=INFO
iterations = 4
alignOrientation=true
alignPosition=true
\end{minted}

Then one can run
\begin{verbatim}
    /path/to/corryvreckan/bin/corry 
        -c align_telescope.conf
    	[-o detectors_file=<detectorsFile> 
    	-o detectors_file_updated=<detectorsFileUpdated> 
    	-o histogramFile=<histogramFile> 
    	-o EventLoaderTimepix3.inputDirectory=<inputDir>]
\end{verbatim}

The actual prealignment is only performed after the events have been analysed and written to the detectors file in the finalizing step. 
This means to check whether the alignment has improved, one needs to re-run the analysis or the next iteration of the alignment as the previously generated ROOT file corresponds to the initial alignment.
This is the case for every iteration of the prealignment or alignment.

Generally, it suffices to run the \texttt{[Prealignment]} module once and then proceed with the next step.

\subsection*{Alignment of the Telescope}
After the prealignment, the actual \textbf{precise} alignment can be performed using the \texttt{AlignmentTrackChi2} module (see Section~\ref{sec:alignmenttrackchi2}).
To this end, \texttt{align\_tel.conf} needs to be modified such that the prealignment is disabled and the alignment is enabled:
\begin{minted}[frame=single,framesep=3pt,breaklines=true,tabsize=2,linenos]{ini}
...
#[Prealignment]
#[Ignore]
[AlignmentTrackChi2]
log_level=INFO
iterations = 4
alignOrientation=true
alignPosition=true
\end{minted}

The algorithm performs an optimisation of the track $\chi^2$.
Typically, the alignment needs to be iterated a handful of times until the residuals (which again can be inspected in the ROOT file after re-running the analysis) are nicely centered around 0 and narrow.
In fact, the width of the residuals corresponds to the spatial resolution of each plane (convoluted with the resolution of the telescope) and should thus be smaller than the respective pixel size.
Starting with a \texttt{spatialCut} in \texttt{[Tracking4D]} (see Section~\ref{tracking4d}) of multiple ($\sim4$) pixel sizes, it should be decreased incrementally down to the pixel size (e.g. run \SI{200}{\micro\m} twice, then run \SI{150}{\micro\m} twice, then \SI{100}{\micro\m} twice, and then \SI{50}{\micro\m}) twice.
This allows to perform the alignment with a tight selection of very high quality tracks only.
Also the \texttt{max\_track\_chi2ndof} should be decrease for the same reason.
For the further analysis, the cuts can be released again.

Sometimes, the procedure runs into a 'false minimum' or 'gets stuck' and does not converge properly which requires to go one step back and improve the prealignment.

Once the alignment is done, one should obtain narrow residuals centered around 0 and a good distribution of the track $\chi^2$ as shown in Figures~\ref{fig:exampleAlignment}.
If the alignment keeps to fail, it is possible to allow only for rotational or translational alignment while freezing the other for one or a few iterations.

\begin{minted}[frame=single,framesep=3pt,breaklines=true,tabsize=2,linenos]{ini}
...
#[Prealignment]
#[Ignore]
[AlignmentTrackChi2]
log_level=INFO
iterations = 4
alignOrientation=false #<-- disable rotational alignment
alignPosition=true
\end{minted}

\begin{figure}
    \centering
    \begin{subfigure}[t]{0.66\textwidth}
        \includegraphics[width=\textwidth]{trackChi2ndof_goodexample}
        \caption{Good example of a track $\chi^2$/ndf distribution.}
        \label{fig:trackChi2}
    \end{subfigure}
    \begin{subfigure}[t]{0.66\textwidth}
        \includegraphics[width=\textwidth]{correlationX_goodexample}
        \caption{Good example of a correlation plot.}
        \label{fig:correlationX}
    \end{subfigure}
    \begin{subfigure}[t]{0.66\textwidth}
        \includegraphics[width=\textwidth]{residualX_goodexample}
        \caption{Good example of a residual distribution.}
        \label{fig:residualX}
    \end{subfigure}
    \caption{Examples of distributions as they should look like.}
    \label{fig:exampleAlignment}
\end{figure}

The alignment can be further improved by using the module \texttt{[AlignmentMillepede]} (see Section~\ref{sec:alignmentmillepede}).
It requires a rather good alignment already, so it should not be used directly after a coarse prealignment by hand or \texttt{[Prealignment]}.
It is recommended to use the last (tightest) cuts that have been used for the telescope alignment in the previous step and then reduce them further.
Once the alignment has converged, this module stops and the alignment is complete.

\textbf{Note:} When starting the alignment procedure from a slightly different initial geometry, the resulting alignment (i.e.~the numbers in the detectors file) will differ slightly which is acceptable. What should \textbf{not} differ is the width of the residuals.

\section{Aligning the DUT}
\label{sec:align_dut}
Once the telescope is aligned, its geometry is not touched anymore. From now on, it is used to build tracks which are then matched to clusters on the DUT.

\subsection*{Prealignment of the DUT}
The prealignment of the DUT follows the same strategy as for the telescope. To look at the current alignment, the script
\begin{verbatim}
    /path/to/corryvreckan/bin/corry 
    	-c analyse_atlaspix.conf 
    	[-o detectors_file=<detectorsFile> 
    	-o histogramFile=<histogramFile> 
    	-o EventLoaderTimepix3.inputDirectory=<inputDir_TPX>
    	-o EventLoaderATLASpix.inputDirectory=<inputDir_APX>]
\end{verbatim}
needs to be run.
If no better guess is available, the initial alignment of the DUT should be set to $x=y=z=0$.

Then, by repeatedly running \corry and modifying the position of the DUT in the detectors file one should be able to bring the peaks of the correlations in x and y close to 0.
If no peak at all can be seen in the correlation plots, potentially some values need to be corrected in the configuration file.
If working with an ATLASpix, these are most likely \texttt{clockCycle} or \texttt{clkdivend2} in \texttt{[EventLoaderATLASpix]} (see Section~\ref{eventloaderatlaspix}).

\textbf{Important: }If using the \texttt{[Prealignment]} module, it is possible to prealign all planes at once as described above in Section~\ref{sec:align_tel}.
If only the DUT shall be prealigned here, the parameter \texttt{name = <name\_of\_dut>} needs to be used.
Otherwise, the telescope planes are also shifted again destroying the telescope alignment.

\begin{minted}[frame=single,framesep=3pt,breaklines=true,tabsize=2,linenos]{ini}
...
[Prealignment]
name = <name_of_dut> # <-- otherwise the telescope planes will be moved!

[Ignore]
#[AlignmentDUTResiduals]
log_level=INFO
iterations = 4
alignOrientation=true
alignPosition=true
\end{minted}

\subsection*{Alignment of the DUT}
Again, the alignment strategy for the DUT is similar as for the telescope and requires multiple iterations.
In \texttt{align\_dut.conf}, the prealignment needs to be disabled and the alignment enabled.
Now, the algorithm optimizes the residuals of the tracks through the DUT.

\begin{minted}[frame=single,framesep=3pt,breaklines=true,tabsize=2,linenos]{ini}
...
#[Prealignment]
#[Ignore]
[AlignmentDUTResiduals]
log_level=INFO
iterations = 4
alignOrientation=true
alignPosition=true
\end{minted}

Then run
\begin{verbatim}
    /path/to/corryvreckan/bin/corry 
    	-c align_dut.conf 
    	[-o detectors_file=<detectorsFile> 
    	-o detectors_file_updated=<detectorsFileUpdated> 
    	-o histogramFile=<histogramFile> 
    	-o EventLoaderTimepix3.inputDirectory=<inputDir_TPX>
    	-o EventLoaderATLASpix.inputDirectory=<inputDir_APX>]
\end{verbatim}

\textbf{Note:} The histograms of the residuals for the DUT in \texttt{[Tracking4D]} are empty. The correct ones can be found in \texttt{[AnalysisDUT]} (see Section~\ref{sec:analysisdut}).

Like for the telescope alignment, the widths of the residuals can be interpreted as the spatial resolution of the DUT (convoluted with the resolution of the telescope) and should thus be $\lesssim$~pixel size.
Again, starting with a \texttt{spatialCut} in \texttt{[DUTAssociation]} (see Section~\ref{sec:dutassociation}) of multiple ($\sim4$) pixel sizes, it should be decreased incrementally down to the pixel size. Note that an asymmetric pixel geometry requires the \texttt{spatialCut} to be chosen accordingly.

If the alignment keeps to fail, it is possible to allow only for rotational or translational alignment while freezing the other for one or a few iterations.

\begin{minted}[frame=single,framesep=3pt,breaklines=true,tabsize=2,linenos]{ini}
...
#[Prealignment]
#[Ignore]
[AlignmentDUTResiduals]
log_level=INFO
iterations = 4
alignOrientation=false #<-- disable rotational alignment
alignPosition=true
\end{minted}
